<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <h3></h3>
    <div id="verCode">
        <img src="" alt="">
    </div>
    <h3></h3>
    <div>
        <input type="text" id="username" />
        <input type="text" id="password" />
        <button type="button" id="login">login</button>
    </div>
    <h3>joi</h3>
    <div>
        <input type="text" id="joi" />
        <button type="button" id="joi_btn">send</button>
    </div>
    <h3>xss</h3>
    <div>
        <textarea name="" id="textarea" cols="30" rows="10"></textarea>
    </div>
    <h3>log</h3>
    <div>
        <button type="button" id="log">点此按钮，将记录日志</button>
    </div>
</body>
<script type="text/javascript" src="javascripts/jsencrypt.js"></script>
<script>

getCode();
document.getElementById('verCode').addEventListener('click', function() {
    getCode();
});

document.getElementById('login').addEventListener('click', function() {
    getKey().then(function(secret) {
        login(secret)
    });
});
document.getElementById('joi_btn').addEventListener('click', function() {
    var val = parseInt(document.getElementById('joi').value);

    if (isNaN(val)) {
        // 输入了以字母开头的字符串
        val = document.getElementById('joi').value;
    }

    fetch('/api/joi', {
        method: 'post',
        body: JSON.stringify({
            must: val
        })
    }).then(function(data) {
        return data.json();
    }).then(function(data) {
        debugger;
    });
});

document.getElementById('log').addEventListener('click', function() {
    fetch('/api/log4js');
});

function login(publicKey) {
    var encrypt = new JSEncrypt(),
        username = document.getElementById('username').value,
        password = document.getElementById('password').value;

    encrypt.setPublicKey(publicKey);
    // 加密密码
    password = encrypt.encrypt(password);

    return fetch('/api/login', {
        method: 'POST',
        body: JSON.stringify({
            username,
            password
        }),
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
        },
    }).then(function(data) {
        // 转json
        return data.json();
    }).then(function(data) {
        if (data.result) {
            alert('登录成功');
        }
    });
}

function getKey() {
    return fetch('/api/publicKey').then(function(data) {
        // 转json
        return data.json();
    }).then(function(data) {
        return data.secret;
    });
}

function getCode() {
    fetch('/api/verificationCode').then(function(data) {
        // 转json
        return data.json();
    }).then(function(data) {
        document.getElementById('verCode').innerHTML = data.data + '<span>' + data.text + '</span>';
    });
}
</script>
</html>